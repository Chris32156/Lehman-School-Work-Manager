<!DOCTYPE html>
<html lang="en">
<head>
    <title>Lehman Schoolwork Manager</title>
    <link rel="shortcut icon" href="LHS_Logo.png">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="756686475707-9oq5b2s576caedn7onn2c01qb4odheh4.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer>
    </script>
</head>
<body id="viewport">
    <div id="Top">
        <h2 style="font-family: Arial" ,>Lehman Schoolwork Manager</h2>
    </div>
    <a id="SignOut" href="#" onclick="signOut();">Sign Out</a>
    <a id ="Attendance"href="https://docs.google.com/forms/d/e/1FAIpQLSfyiHPoJZpV3wHEgzdrbj0-tJbGCCSQm27OXbQivUwrRQjd9A/viewform?vc=0&c=0&w=1&flr=0">Daily Attendance</a>
    <pre id="content" style="white-space: pre-wrap;"></pre>
    <script type="text/javascript">

        // Client ID and API key from the Developer Console
        var CLIENT_ID = '756686475707-9oq5b2s576caedn7onn2c01qb4odheh4.apps.googleusercontent.com';
        var API_KEY = 'AIzaSyBLKPsNynG3ITUCF5IA2fWWYRvjjXA75HU';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

        var PeriodTimes = ["9:01 - 9:46", "9:48 - 10:33", "10:35 - 11:20", "11:22 - 12:07", "12:09 - 12:54", "12:56 - 1:41", "1:43 - 2:28"];
        var Assignments = ["", "", "", "", "", "", ""];

        function LoadWebsite() {
            LoadAssignments();
            LoadTeachers();
        }

        function LoadAssignments() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1QPL2j4jQ6zxYcPpMHOVegIX0z_IahOuC_QdOBEKQtJA',
                range: 'Sheet1!D2:F',
            }).then(function (response) {
                var range = response.result;

                // Decleare Vars
                var reachedEnd = false;
                var i = 0;

                // List Assignments
                while (!reachedEnd) {
                    // Checks if there is assignment
                    if (range.values[i] == null) {
                        reachedEnd = true;
                    }
                    else {
                        var row = range.values[i];
                        var assignmentString = row[1] + " Due " + row[0];

                        // Add to assignments array
                        if (i < 8) {
                            Assignments[i] = assignmentString;
                        }

                        // Checks if there is a link attached
                        if (row[2] == null) {
                            appendPre(assignmentString, "Assignments");
                        }
                        else {
                            var pre = document.getElementById("Assignments");
                            pre.style.textAlign = "center";
                            var a = document.createElement('a');
                            var link = document.createTextNode(assignmentString);
                            a.appendChild(link);
                            a.title = row[1];
                            a.href = row[2];
                            pre.appendChild(a);

                            // Create Line Break
                            var linebreak = document.createElement("br");
                            pre.appendChild(linebreak);
                        }
                        i++;
                    }
                }

                LoadSchedule();

                }, function (error) {
                    appendPre(JSON.stringify(error, null, 2));
                })
        }

        function LoadTeachers() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1Mduth0RGyZtq64RzZg6aM3kHPchL18N6zc6x5RSbYeQ',
                range: 'Class Data!Q2:Y',
            }).then(function (response) {
                var range = response.result;
                // Get row of student's classes
                var row = range.values[1];

                for (var i = 0; i < 9; i++)
                {
                    if (row[i] != null) {
                        // Create Link
                        var pre = document.getElementById("Teachers");
                        pre.style.textAlign = "center";
                        var a = document.createElement('a'); 
                        var link = document.createTextNode(row[i]);
                        a.appendChild(link);
                        a.title = row[i];

                        // Find teachers Last Name
                        var x;
                        for (j = 0; j < row[i].length; j++) {
                            if (row[i][j] == '.')
                            {
                                x = j;
                            }
                        }
                        var lastName = row[i].substring(x + 2, row[i].length);

                        // Set link values
                        var link = "https://mail.google.com/mail/?view=cm&fs=1&to=" + lastName + "%40lehmanhs.com&authuser=1";
                        a.href = link;

                        pre.appendChild(a);

                        // Create Line Break
                        var linebreak = document.createElement("br");
                        pre.appendChild(linebreak);
                    }
                }

                }, function (error) {
                    appendPre(JSON.stringify(error, null, 2));
                })
        }

        function LoadSchedule() {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1Mduth0RGyZtq64RzZg6aM3kHPchL18N6zc6x5RSbYeQ',
                range: 'Class Data!A2:P',
            }).then(function (response) {
                var range = response.result;
                // Get row of student's classes
                var row = range.values[1];
                var x = 0;
                appendPre("Today is an A day.", "Schedule");
                for (var i = 2; i < 9; i++)
                {
                    if (row[i] != "") {
                        appendPre(PeriodTimes[i - 2] + ": " + row[i] + " Class", "Schedule");
                    }
                    else {
                        appendPre(PeriodTimes[i - 2] + ": " + Assignments[x], "Schedule");
                        x++;
                    }
                }

                }, function (error) {
                    appendPre(JSON.stringify(error, null, 2));
                })
        }

        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        function onSignIn(googleUser) {
            /*
            // Useful data for your client-side scripts:
            var profile = googleUser.getBasicProfile();
            console.log("ID: " + profile.getId()); // Don't send this directly to your server!
            console.log('Full Name: ' + profile.getName());
            console.log('Given Name: ' + profile.getGivenName());
            console.log('Family Name: ' + profile.getFamilyName());
            console.log("Image URL: " + profile.getImageUrl());
            console.log("Email: " + profile.getEmail());

            // The ID token you need to pass to your backend:
            var id_token = googleUser.getAuthResponse().id_token;
            console.log("ID Token: " + id_token);

            listMajors(profile.getEmail()); */
        }
        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(function () {
                // Listen for sign-in state changes.
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                // Handle the initial sign-in state.
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                LoadWebsite();
            }, function (error) {
                appendPre(JSON.stringify(error, null, 2));
            });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */

        function appendPre(message, id) {
            var pre = document.getElementById(id);
            pre.style.textAlign = "center";
            var textContent = document.createTextNode(message);
            pre.appendChild(textContent);
            var linebreak = document.createElement("br");
            document.getElementById(id).appendChild(linebreak);
        }

        function signOut() {
            handleSignoutClick();

            var auth2 = gapi.auth2.getAuthInstance();
            auth2.signOut().then(function () {
                console.log('User signed out.');
            });

            window.location.href = "index.html";
        }
        /**
         * Print the names and majors of students in a sample spreadsheet:
         * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
         */

        function listMajors(email) {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: '1Mduth0RGyZtq64RzZg6aM3kHPchL18N6zc6x5RSbYeQ',
                range: 'Class Data!A2:L',
            }).then(function (response) {
                var range = response.result;
                if (range.values.length > 0) {
                    appendPre('Welcome ' + email + '.');
                    appendPre('Student ID, Name, Class Level, Extracurricular, P1, P2, P3, P4, P5, P6, P7, P8');
                    /* for (i = 0; i < 2; i++) { // range.values.length, i < num of students
                        var row = range.values[i];
                        // Print columns A and E, which correspond to indices 0 and 4.
                        appendPre(row[0] + ', ' + row[1] + ', ' + row[2] + ', ' + row[3] + ', ' + row[4] + ', ' + row[5] + ', ' + row[6] + ', ' + row[7] + ', ' + row[8] + ', ' + row[9] + ', ' + row[10] + ', ' + row[11]);
                    } */
                    if (email == "csch0981@lehmanhs.com") {
                        var row = range.values[1];
                        appendPre(row[0] + ', ' + row[1] + ', ' + row[2] + ', ' + row[3] + ', ' + row[4] + ', ' + row[5] + ', ' + row[6] + ', ' + row[7] + ', ' + row[8] + ', ' + row[9] + ', ' + row[10] + ', ' + row[11]);
                    }
                    else if (email == "rrat7361@lehmanhs.com") {
                        var row = range.values[0];
                        appendPre(row[0] + ', ' + row[1] + ', ' + row[2] + ', ' + row[3] + ', ' + row[4] + ', ' + row[5] + ', ' + row[6] + ', ' + row[7] + ', ' + row[8] + ', ' + row[9] + ', ' + row[10] + ', ' + row[11]);
                    }
                    else if (email == "toni.pizza@nyu.edu") {
                        appendPre("If you were a student your schedule would show here");
                    }
                    else if (email == "obrien@lehmanhs.com") {
                        appendPre("Hello Mr Obrien");
                    }
                    else {
                        appendPre("Schedule not found for user");
                    }
                } else {
                    appendPre('No data found.');
                }
            }, function (response) {
                appendPre('Error: ' + response.result.error.message);
                });

        }
    </script>
    <script async defer src="https://apis.google.com/js/api.js"
            onload="this.onload=function(){};handleClientLoad()"
            onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

    <div id="Assignments">
        <h3 style="font-family: Arial" ,>Assignments</h3>
    </div>
    <div id="Schedule">
        <h3 style="font-family: Arial" ,>Schedule</h3>
    </div>
    <div id="Teachers">
        <h3 style="font-family: Arial" ,>Teachers</h3>
    </div>
</body>
</html>
